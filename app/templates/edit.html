{% extends "base.html" %}

{% block content %}
<div class="edit-nav">
    <a href="{{ url_for('main.index') }}" class="btn btn-sm btn-back">&larr; Back to list</a>
    <div class="edit-nav-arrows">
        {% if prev_id %}
            <a id="prev-link" href="{{ url_for('main.edit_cultivar', cultivar_id=prev_id) }}" class="btn btn-sm">&larr; Prev</a>
        {% else %}
            <span class="btn btn-sm disabled">&larr; Prev</span>
        {% endif %}
        {% if next_id %}
            <a id="next-link" href="{{ url_for('main.edit_cultivar', cultivar_id=next_id) }}" class="btn btn-sm">Next &rarr;</a>
        {% else %}
            <span class="btn btn-sm disabled">Next &rarr;</span>
        {% endif %}
    </div>
</div>

<div class="edit-form">
    <h2 class="edit-title">{{ cultivar.cultivar }}</h2>

    {% if cultivar.photo_url %}
    <div class="edit-photo">
        <img src="{{ cultivar.photo_url }}" alt="{{ cultivar.cultivar }}">
    </div>
    {% endif %}

    <div class="edit-fields">
        <div class="field-group">
            <label for="f-epithet">Epithet</label>
            <input type="text" id="f-epithet" name="epithet" value="{{ cultivar.epithet }}">
        </div>
        <div class="field-group">
            <label for="f-category">Category</label>
            <input type="text" id="f-category" name="category" value="{{ cultivar.category }}">
        </div>
        <div class="field-group">
            <label for="f-color_form">Color / Form</label>
            <input type="text" id="f-color_form" name="color_form" value="{{ cultivar.color_form }}">
        </div>
        <div class="field-group field-group-tooltip">
            <label for="f-tagline">Tagline</label>
            <input type="text" id="f-tagline" name="tagline" value="{{ cultivar.tagline }}">
            <div class="tagline-tooltip">{{ cultivar.tagline }}</div>
        </div>
        <div class="field-group field-group-wide">
            <label for="f-description">Description</label>
            <textarea id="f-description" name="description" rows="4">{{ cultivar.description }}</textarea>
        </div>
        <div class="field-group field-group-wide">
            <label>Notes</label>
            <div id="notes-editor">{{ cultivar.notes|safe }}</div>
        </div>
        <div class="field-group">
            <label for="f-image_url">Image URL (ICR)</label>
            <input type="text" id="f-image_url" name="image_url" value="{{ cultivar.image_url }}">
        </div>
        <div class="field-group">
            <label for="f-photo_url">Photo URL</label>
            <input type="text" id="f-photo_url" name="photo_url" value="{{ cultivar.photo_url }}">
        </div>
    </div>

    <div class="edit-actions">
        <button id="save-btn" class="btn">Save</button>
        <span id="save-status" class="save-status"></span>
    </div>

    <div class="history-section">
        <button id="history-toggle" class="btn btn-sm btn-back">Show Change History</button>
        <div id="history-panel" class="hidden"></div>
    </div>
</div>

<div class="save-indicator" id="save-indicator"></div>
{% endblock %}

{% block scripts %}
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
<script>
(function() {
    const cultivarId = {{ cultivar.id }};

    const quill = new Quill('#notes-editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                ['bold', 'italic', 'underline'],
                [{ list: 'ordered' }, { list: 'bullet' }],
                ['link'],
                ['clean']
            ]
        },
        placeholder: 'Notes...'
    });

    const saveBtn = document.getElementById('save-btn');
    const saveStatus = document.getElementById('save-status');

    const historyToggle = document.getElementById('history-toggle');
    const historyPanel = document.getElementById('history-panel');
    let historyLoaded = false;

    saveBtn.addEventListener('click', async () => {
        saveBtn.disabled = true;
        saveStatus.textContent = 'Saving...';
        saveStatus.className = 'save-status';

        const data = {
            epithet: document.getElementById('f-epithet').value,
            category: document.getElementById('f-category').value,
            color_form: document.getElementById('f-color_form').value,
            tagline: document.getElementById('f-tagline').value,
            description: document.getElementById('f-description').value,
            notes: quill.root.innerHTML,
            image_url: document.getElementById('f-image_url').value,
            photo_url: document.getElementById('f-photo_url').value,
        };

        try {
            const resp = await fetch(`/api/cultivar/${cultivarId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });
            if (!resp.ok) throw new Error('Save failed');
            saveStatus.textContent = 'Saved';
            saveStatus.classList.add('success');
            historyLoaded = false;
            if (!historyPanel.classList.contains('hidden')) {
                loadHistory();
            }
        } catch (e) {
            saveStatus.textContent = 'Error saving';
            saveStatus.classList.add('error');
        } finally {
            saveBtn.disabled = false;
            setTimeout(() => { saveStatus.textContent = ''; }, 3000);
        }
    });

    function stripHtml(html) {
        const tmp = document.createElement('div');
        tmp.innerHTML = html;
        return tmp.textContent || '';
    }

    function escapeHtml(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    async function loadHistory() {
        historyPanel.innerHTML = '<p style="color:#666;font-size:0.85rem;">Loading...</p>';
        try {
            const resp = await fetch(`/api/cultivar/${cultivarId}/history`);
            if (!resp.ok) throw new Error('Failed to load');
            const records = await resp.json();
            if (records.length === 0) {
                historyPanel.innerHTML = '<p style="color:#666;font-size:0.85rem;">No changes recorded yet.</p>';
                historyLoaded = true;
                return;
            }
            let html = '';
            records.forEach(e => {
                const date = new Date(e.timestamp).toLocaleString();
                const isNotes = e.field_name === 'notes';
                const oldVal = isNotes ? stripHtml(e.old_value) : e.old_value;
                const newVal = isNotes ? stripHtml(e.new_value) : e.new_value;
                html += `<div class="history-entry">` +
                    `<span class="history-date">${escapeHtml(date)}</span> ` +
                    `<span class="history-field-name">${escapeHtml(e.field_name)}</span> ` +
                    `<span class="history-old">${escapeHtml(oldVal || '(empty)')}</span>` +
                    ` &rarr; ` +
                    `<span class="history-new">${escapeHtml(newVal || '(empty)')}</span>` +
                    `</div>`;
            });
            historyPanel.innerHTML = html;
            historyLoaded = true;
        } catch (e) {
            historyPanel.innerHTML = '<p style="color:#c0392b;font-size:0.85rem;">Error loading history.</p>';
        }
    }

    historyToggle.addEventListener('click', () => {
        const hidden = historyPanel.classList.toggle('hidden');
        historyToggle.textContent = hidden ? 'Show Change History' : 'Hide Change History';
        if (!hidden && !historyLoaded) {
            loadHistory();
        }
    });
})();
</script>
{% endblock %}
